---
title: "Untitled"
output: html_document
date: "2024-07-28"
---


```{r,warning=FALSE,fig.width=8,fig.height=6}
library(vegan)
library(betapart)
library(agricolae)
library(ggplot2)
rm(list=ls())
setwd("/Users/yangjianxia/Desktop/npj.code/Figs3.Figs4")
bind<-read.csv("ribotaxa_relative.csv",header = T)
col11<-c("slateblue1","steelblue1","tan1","thistle1","tomato","turquoise", "violet", "red",
         "yellowgreen","peachpuff", "peru", "pink", "plum2", "purple","wheat", "cornsilk3","cornsilk",
         "coral4","coral","chocolate4","chocolate","black","chartreuse4","chartreuse","burlywood4","burlywood",
         "brown4","blue","bisque4","bisque","azure4","azure","aquamarine4","aquamarine","antiquewhite4","antiquewhite",
         "aliceblue","dodgerblue4","dodgerblue","dimgrey","deepskyblue4", "deepskyblue", "deeppink4", "deeppink","darkviolet",
         "darkslategray4","darkslategray","darkseagreen4", "darkseagreen", "darksalmon", "darkred", "darkorchid4", "darkorchid",
         "darkorange4", "darkorange","firebrick","darkgreen","darkgoldenrod4", "darkgoldenrod", "darkcyan","cyan")
col12<-c("slateblue1","springgreen","steelblue1","tan1","thistle1","tomato","turquoise", "violet", "red",
         "yellowgreen","peachpuff", "peru", "pink", "plum2", "purple","wheat", "cornsilk3","cornsilk",
         "coral4","coral","chocolate4","chocolate","black","chartreuse4","chartreuse","burlywood4","burlywood",
         "brown4","blue","bisque4","bisque","azure4","azure","aquamarine4","aquamarine","antiquewhite4","antiquewhite",
         "aliceblue","dodgerblue4","dodgerblue","dimgrey","deepskyblue4", "deepskyblue", "deeppink4", "deeppink","darkviolet",
         "darkslategray4","darkslategray","darkseagreen4", "darkseagreen", "darksalmon", "darkred", "darkorchid4", "darkorchid",
         "darkorange4", "darkorange","firebrick","darkgreen","darkgoldenrod4", "darkgoldenrod", "darkcyan","cyan")
bind$Nlevel <- factor(bind$Nlevel, levels=c("0","2","5","10","15","20","50"),ordered = T)
ggplot(bind, aes(x = Nlevel, y = Relative_Abundance, fill=Domain)) +
  geom_bar(stat='identity', position = "fill")+  
  xlab(bquote(N~addition~levels~(g~N~m^-2~yr^-1))) +
  ylab(bquote('Relative contribution'))+
  scale_fill_manual(values= col11)+
  theme_bw()+
  guides(fill=guide_legend(title= "Domain"))+
  theme(strip.text = element_text(size = 10,face="bold"),
        panel.spacing = unit(0, "lines"),
        legend.title = element_text(colour="black", size=10, face="bold"),
        legend.text = element_text(colour="black", size=10, face="bold"),
        axis.text.y=element_text(colour="black",size=10,face="bold"),
        axis.text.x=element_text(colour="black",size=14,face="bold"),
        axis.title=element_text(colour="black",size=20,face="bold"))+
  scale_y_continuous(labels = scales::percent)
ggsave("figs3.taxa_relative.pdf",height = 6,width = 8) 

OTU<-read.csv("ribotaxa_bac_otu.csv",header = T,row.names = 1)
set.seed(315)
OTU<-ceiling(OTU[,1:70])
otu.rarify <- t(rrarefy(t(OTU), min(colSums(OTU)))) #以xxx为最小稀释的

alpha<-data.frame(t(otu.rarify))
#alpha<-t(OTU)
##shannon指数
Shannon.Wiener<-diversity(alpha,index = "shannon")

###simpson指数
Simpson<-diversity(alpha,index = "simpson")
###observed_species
observed_species<-specnumber(alpha)
###chao1
Chao1<-estimateR(alpha)[2,]
###ACE指数
ACE<-estimateR(alpha)[4,]
alphadata<-data.frame(Shannon.Wiener,Simpson,observed_species)
env0<-read.csv("env1.csv",header = T,row.names = 1)
da<-cbind(alphadata,env0)
da$LN<-log(da$Nlevel+1)
da$LN<-as.numeric(da$LN)
##统计分析,分开
data1 <-da[da$Nadd=="Ncont",] 
summary(lm(data1$observed_species~data1$LN))
###r2=0.427,p<0.001
data2 <-da[da$Nadd=="Ncess",] 
summary(lm(data2$observed_species~data2$LN))
###r2=0.223 p=0.002
summary(lm(da$observed_species~da$LN))
p1<-ggplot(da,aes(x=LN,y=observed_species,colour=Nadd))+
  #geom_smooth(data=da,aes(x=LN, y=observed_species), method = "lm", color = "black",linewidth=2)+
  geom_jitter(height = 0, alpha = 0.5, size =13) + 
  scale_shape_manual(values=c(16,16))+
  scale_colour_manual(values=c("blue","red"),
                      labels=c(expression(N[cess]),expression(N[cont])))+
  xlab(bquote(Log[e]~(N~level~+~1)))+
  ylab(bquote('S.Bacteria'))+
  #ylim(3700,3800)+
  # annotate("text",x=2,y=250,parse=TRUE,label='atop(italic(R^2)==0.326)',size=6, face="bold",color="black")+
  #annotate("text",x=2,y=230,parse=TRUE,label='atop(italic(P) < 0.001)',size=6, face="bold",,color="black")+
  guides(colour=guide_legend(title = expression(N[add])))+theme_bw()+
  theme(text=element_text(size=20,  family="sans"))+
  theme(legend.title = element_text(colour="black", size=20),
        legend.text = element_text(colour="black", size=20),
        axis.text=element_text(colour="black",size=20),
        axis.title=element_text(colour="black",size=18))
p1<-p1+theme(panel.border = element_rect(fill = NA,color = "black",size=3.5,linetype = "solid"))
p1
ggsave("figs4a.bac.S.ribotaxa.pdf",width = 8,height = 6)
summary(lm(da$Shannon.Wiener~da$LN))
p1<-ggplot(da,aes(x=LN,y=Shannon.Wiener,colour=Nadd))+
  # geom_smooth(data=da,aes(x=LN, y=Shannon.Wiener), method = "lm", color = "black",linewidth=2)+
  geom_jitter(height = 0, alpha = 0.5, size =13) + 
  scale_shape_manual(values=c(16,16))+
  scale_colour_manual(values=c("blue","red"),
                      labels=c(expression(N[cess]),expression(N[cont])))+
  xlab(bquote(Log[e]~(N~level~+~1)))+
  ylab(bquote('H.Bacteria'))+
  #ylim(3700,3800)+
  #annotate("text",x=2,y=4.2,parse=TRUE,label='atop(italic(R^2)==0.316)',size=6, face="bold",color="black")+
  #annotate("text",x=2,y=4.1,parse=TRUE,label='atop(italic(P) < 0.001)',size=6, face="bold",,color="black")+
  guides(colour=guide_legend(title = expression(N[add])))+theme_bw()+
  theme(text=element_text(size=20,  family="sans"))+
  theme(legend.title = element_text(colour="black", size=20),
        legend.text = element_text(colour="black", size=20),
        axis.text=element_text(colour="black",size=20),
        axis.title=element_text(colour="black",size=18))
p1<-p1+theme(panel.border = element_rect(fill = NA,color = "black",size=3.5,linetype = "solid"))
p1
ggsave("figs4b.bac.H.ribotaxa.pdf",width = 8,height = 6)
```

